# Hamess Pack Deployment & Installation Specification

**Version:** 1.0
**Status:** Approved for Release Candidate
**Scope:** Mobile (Android/iOS), Web (PWA), Desktop, and Notification Infrastructure

---

## 1. App Build & Release Strategy

To ensure a consistent experience across all platforms while minimizing codebase fragmentation, Hamess Pack utilizes a **Hybrid Deployment Strategy**.

*   **Core Framework:** React (Single Page Application).
*   **Mobile Runtime:** Capacitor (Wraps the React app into native webviews for iOS/Android).
*   **Web Strategy:** Progressive Web App (PWA) with offline-first capabilities via Service Workers.
*   **Desktop Strategy:** PWA installation via Chrome/Edge or Electron wrapper for dedicated admin terminals.

**Build Pipeline Principles:**
1.  **Single Source of Truth:** The `build/` directory generated by the React build process is the source for all platforms.
2.  **Environment Segregation:** Separate build configurations for `staging` (TestFlight/Internal Testing) and `production` (App Store/Play Store).
3.  **Versioning:** Semantic Versioning (e.g., 1.2.0) must be synchronized across `package.json`, Android `versionCode`, and iOS `CFBundleVersion`.

---

## 2. Mobile Deployment (Android & iOS)

### A. Android (Google Play Store)
1.  **Signing & Keystores:**
    *   Generate a Production Upload Key. Store this securely in a password manager or dedicated secrets vault.
    *   **Do NOT** commit the `.keystore` or `.jks` file to version control.
    *   Utilize **Play App Signing**: Google manages the distribution key, while you sign with the upload key.
2.  **Build Artifact:**
    *   Generate an Android App Bundle (`.aab`) instead of a traditional APK for optimized delivery size.
3.  **Manifest Configuration:**
    *   Ensure permissions in `AndroidManifest.xml` (Camera, Internet, Geolocation) match exactly what is declared in the Privacy Policy.
    *   Verify `android:usesCleartextTraffic` settings based on API security requirements (should be false for production).

### B. iOS (Apple App Store)
1.  **Certificates & Profiles:**
    *   Create a Distribution Certificate and a specific App ID in the Apple Developer Portal.
    *   Generate a Provisioning Profile for App Store Distribution.
2.  **Capabilities:**
    *   Enable "Push Notifications" and "Associated Domains" (for Universal Links) in Xcode capabilities.
3.  **Build Process:**
    *   Sync the web build to the `ios` directory.
    *   Archive the build in Xcode.
    *   Validate and Distribute to **TestFlight** first.
4.  **Privacy Manifest:**
    *   Include the new `PrivacyInfo.xcprivacy` file detailing usage of required reason APIs (e.g., disk space, boot time) if applicable.

---

## 3. Web PWA Deployment

1.  **Hosting Infrastructure:**
    *   Deploy to a high-availability CDN (e.g., Vercel, Netlify, or AWS CloudFront).
    *   Ensure HTTPS is enforced; Service Workers will not register over HTTP.
2.  **Service Worker Strategy:**
    *   **Cache-First:** For static assets (images, fonts, CSS).
    *   **Network-First:** For API calls (Orders, Stock levels).
    *   **Stale-While-Revalidate:** For catalog data (Products list).
3.  **Manifest Validation:**
    *   Validate `manifest.json` for required fields: `name`, `short_name`, `start_url`, `display` (standalone), and icons (min 192px and 512px).
    *   Ensure `maskable` icons are provided for Android 13+ adaptive icons.

---

## 4. Desktop Deployment

1.  **PWA Installation (Recommended):**
    *   Admins install the app via the browser (Chrome/Edge) "Install App" button.
    *   Desktop shortcut behaves like a native window.
2.  **Electron Wrapper (Optional):**
    *   Wrap the React build into an Electron app if hardware access (e.g., thermal receipt printers, barcode scanners) requires native Node.js modules.
    *   **Auto-Update:** Implement `electron-updater` to check for new releases on startup.

---

## 5. Deep Linking & Universal Links

To allow notification clicks to open specific order pages directly in the app instead of the browser.

1.  **Concept:**
    *   Map specific URLs (e.g., `https://hamesspack.com/admin/orders/123`) to open the native app.
2.  **Configuration Files:**
    *   **iOS (`apple-app-site-association`):** Host this file at the root of the web domain (without an extension). It must list the App ID and the paths (`/admin/*`) allowed to open the app.
    *   **Android (`assetlinks.json`):** Host at `.well-known/assetlinks.json`. Must contain the package name and the SHA-256 fingerprint of the signing certificate.
3.  **Verification:**
    *   Domain ownership verification must be completed in the Google Play Console and Apple Developer Portal.

---

## 6. Notifications & Real-time Flows

### A. Event Architecture
1.  **Event Trigger:** An order is placed in the React frontend. The backend API receives the `POST /orders` request.
2.  **Event Emission:** Upon successful database commit, the API emits an asynchronous event (`ORDER_CREATED`).
3.  **Message Queue:** This event is pushed to a reliable message queue (e.g., Redis/BullMQ, SQS) to prevent blocking the user response.
4.  **Notification Worker:** A dedicated background worker consumes the job.
5.  **Channel Resolution:** The worker checks Admin preferences (WhatsApp vs. Push) and resolves the provider.
6.  **Provider Dispatch:**
    *   **WhatsApp:** API call to Twilio/Meta API with a pre-approved template.
    *   **Push:** API call to Firebase Cloud Messaging (FCM) or APNs.
7.  **Logging:** The outcome (Success/Failure/Error Code) is written to the audit log.

### B. Device Registration Flow
1.  **Token Acquisition:** On app launch, the Capacitor Push Notification plugin requests permission. If granted, it retrieves the FCM/APNs token.
2.  **Token Storage:** The app sends this token along with the User ID and Device OS to the backend `POST /api/devices`.
3.  **Token Refresh:** Listen for token refresh events and update the backend immediately.

### C. Security & Idempotency
1.  **Signed Admin Links:** Links sent via WhatsApp must contain a short-lived authentication token (HMAC signature) or require an active session. Do not send "magic links" that grant full admin access indefinitely.
2.  **Idempotency:** Use the `Order ID` as the idempotency key. If the webhook or queue processes the same order ID twice, the worker should check if a notification was already logged for that ID and skip the second send.
3.  **Retries:** Implement exponential backoff (e.g., retry after 10s, 1m, 5m) for network failures. After 3 failed attempts, move to a Dead Letter Queue (DLQ).

---

## 7. Security & Secrets

1.  **Secret Storage:**
    *   Store all API Keys (Twilio, Firebase, Database URLs) in environment variables (`.env`) injected at build/runtime.
    *   Never hardcode secrets in the frontend JavaScript bundle.
2.  **Minimum Secrets Set:**
    *   `TWILIO_ACCOUNT_SID` & `TWILIO_AUTH_TOKEN`
    *   `FIREBASE_SERVER_KEY` (or Service Account JSON)
    *   `APP_STORE_CONNECT_API_KEY` (for CI/CD deployment)
    *   `ANDROID_KEYSTORE_PASSWORD`
3.  **Data Privacy:**
    *   **Allowed in Notifications:** First Name, Order ID, Total Amount, City.
    *   **Prohibited:** Full Credit Card Numbers, Specific Home Address (unless necessary for driver app), User Passwords.
4.  **Access Control:**
    *   Ensure the "Test Notification" endpoint is protected and only accessible to authenticated Admins.

---

## 8. Quality Assurance & Testing Matrix

### Test Cases
*   **Unit Tests:** Verify notification worker logic (correct template selection based on language).
*   **Integration Tests:** Flow from `Place Order` -> `DB Commit` -> `Queue` -> `Mock Twilio Call`.
*   **Push Notification Tests:** Verify background vs. foreground reception. Test tapping the notification (Deep Link behavior).
*   **Deep Link Tests:** Verify clicking a link opens the App if installed, or falls back to the Web PWA if not.
*   **Offline Scenarios:** Verify placing an order offline queues it locally (IndexedDB) and syncs upon reconnection.
*   **Large Data Import:** Test importing 3000+ products to ensure IndexedDB performs without UI freezing.

### Test Device Matrix
*   **iOS:** iPhone 11 or newer (iOS 15+).
*   **Android:** A budget device (e.g., Samsung A-series) and a flagship (Pixel/Samsung S-series) running Android 10+.

### Store Testing
*   **TestFlight:** Distribute to internal stakeholders. Acceptance criteria: App launches, login works, push token registers.
*   **Google Play Internal Track:** Same acceptance criteria.

---

## 9. Deployment Rollout Plan & Rollback

1.  **Staged Rollout:**
    *   **Stage 1 (Internal):** Deploy to TestFlight/Play Internal Track. QA Sign-off.
    *   **Stage 2 (Closed Beta):** Deploy to a small group of friendly users (e.g., 5% of admins).
    *   **Stage 3 (Production):** Release to App Stores with "Phased Release" enabled (starts at 1% -> 5% -> 10% -> 100% over 7 days).
2.  **Monitoring Triggers (Rollback Criteria):**
    *   Crash Rate > 1%.
    *   Order Success Rate drops below 98%.
    *   API Latency spikes > 2000ms.
3.  **Rollback Procedure:**
    *   **Web:** Revert the git commit and redeploy to Vercel/Netlify (Instant).
    *   **Mobile:** Submit a new build with the previous stable code and an incremented version number (Requires Review, slower).

---

## 10. Admin & User Installation Instructions

### A. Android
1.  Open the **Google Play Store**.
2.  Search for "Hamess Pack Admin".
3.  Tap **Install**.
4.  Open the app and log in with your Admin credentials.
5.  When prompted "Allow Notifications?", tap **Allow**.

### B. iOS (iPhone/iPad)
1.  (Beta) Open the **TestFlight** app link provided by email.
2.  (Production) Open the **App Store**, search "Hamess Pack Admin", and tap **Get**.
3.  Launch the app.
4.  **Important:** When the app asks for permission to send alerts, tap **Allow** to ensure you receive order updates.

### C. Desktop (Windows/Mac)
1.  Open Google Chrome or Microsoft Edge.
2.  Navigate to `https://admin.hamesspack.com`.
3.  Look for the "Install App" icon in the address bar (right side).
4.  Click **Install**. The app will open in its own window and add a shortcut to your desktop/dock.

### D. Enabling WhatsApp
1.  Go to **Admin Dashboard > Settings > Notifications**.
2.  Ensure "WhatsApp Alerts" is toggled **ON**.
3.  Verify your phone number is correct in the admin profile.

---

## 11. Analytics, Observability & Monitoring

*   **Key Metrics:**
    *   **Orders Per Hour:** Dip indicates system issue.
    *   **Notification Delivery Rate:** Success vs. Failure count from Twilio/FCM.
    *   **Crash Free Users:** Target > 99%.
*   **Tools:**
    *   **Sentry:** For frontend/backend error tracking and performance monitoring.
    *   **Firebase Crashlytics:** For native mobile crashes.
    *   **Datadog / Grafana:** For server/infrastructure monitoring.

---

## 12. Privacy, Legal & App Store Compliance

*   **Privacy Policy:** Must explicitly state that device tokens are collected for order notifications and that phone numbers are shared with Twilio (3rd party) for WhatsApp delivery.
*   **Data Deletion:** The app must provide a way for users to request account/data deletion (App Store requirement).
*   **Permission Priming:** Explain *why* permissions (Camera, Location, Notification) are needed *before* the OS dialog appears.

---

## 13. Deliverables & Handoff Checklist

*   [ ] **Source Code:** Git repository link (Main branch).
*   [ ] **Mobile Builds:** Signed `.aab` (Android) and Archived `.ipa` (iOS).
*   [ ] **Keys:** Keystore files (securely transferred) and API Secrets map.
*   [ ] **Config Files:** `google-services.json` (Android) and `GoogleService-Info.plist` (iOS).
*   [ ] **Web Assets:** PWA Manifest, Service Worker file, Sitemap.
*   [ ] **Documentation:** API Docs, This Deployment Spec, User Manual.
*   [ ] **Accounts:** Credentials for App Store Connect, Google Play Console, Twilio, Firebase.

---

## 14. Appendix: Quick Troubleshooting Guide

| Issue | Possible Cause | Remedy |
| :--- | :--- | :--- |
| **Notifications not arriving** | User denied permission. | Check App Settings > Notifications. Re-prompt user. |
| **Push Token Missing** | Network firewall blocking FCM/APNs. | Check Wi-Fi/Data connection. Restart App. |
| **"App Not Installed" (Android)** | Signing key mismatch. | Uninstall previous version (debug) before installing release version. |
| **Deep link opens browser** | Domain verification failed. | Re-verify `assetlinks.json` / `AASA` file hosting and validity. |
| **Image Upload Fails** | Quota exceeded (LocalStorage). | Confirm IndexedDB migration is active. Clear browser data if needed. |
| **New Products Disappear** | Caching issue. | Hard refresh (Ctrl+F5). Check Service Worker cache strategy. |
